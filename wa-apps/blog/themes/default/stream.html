<div id="post-stream" role="main" class="lazyloading" {if $is_concrete_blog}itemscope itemtype="http://schema.org/Blog"{/if}>

  {if !empty($stream_title) && ($layout_type neq 'lazyloading')}<h1>{$stream_title|escape}</h1>{/if}
  <a name="page_{$page}"></a>
  {foreach $posts as $post} <!-- post item #{$post.id}  -->
    {if !empty($annotation_only)}
    <div class="post search-match" id="post-{$post.id}" {if $is_concrete_blog}itemprop="blogPosts"{/if} itemscope itemtype="http://schema.org/BlogPosting">
      <h3><a href="{$post.link}" itemprop="url">{$post.title|default:'[`(empty title)`]'|escape}</a></h3>
      <span class="hint">
        {if $post.user.posts_link}
          <a href="{$post.user.posts_link}" class="username" rel="author">{$post.user.name|escape}</a>
        {else}
          <span class="username" rel="author">{$post.user.name|escape}</span>
        {/if}
        {$post.datetime|wa_datetime:"humandate"}
      </span>
      <p>
        {$post.text|strip_tags|truncate:400}
      </p>
    </div>
    {else}
    <div class="post" id="post-{$post.id}" {if $is_concrete_blog}itemprop="blogPosts"{/if} itemscope itemtype="http://schema.org/BlogPosting">
      <h3>
        <a href="{$post.link}" itemprop="url">{$post.title|default:'[`(empty title)`]'|escape}</a>

        {* @event prepare_posts_frontend.%plugin_id%.post_title *}
        {if !empty($post.plugins.post_title)}
          <!-- plugin hook: "prepare_posts_frontend.*.post_title" -->
          {foreach $post.plugins.post_title as $plugin => $output}

            <!-- begin "prepare_posts_frontend.{$plugin}.post_title" -->
            {$output}
            <!-- end "prepare_posts_frontend.{$plugin}.post_title" -->
          {/foreach}
          <!-- end plugin hook: "prepare_posts_frontend.*.post_title" -->
        {/if}

      </h3>
      <div class="credentials">

        {if isset($post.user.photo_url_20)}
          {if $post.user.posts_link}
            <a href="{$post.user.posts_link}">
              <img src="{$post.user.photo_url_20}" class="userpic" alt="">
            </a>
          {else if isset($post.user.photo_url_20)}
            <img src="{$post.user.photo_url_20}" class="userpic" alt="">
          {/if}
        {/if}

        {if $post.user.posts_link}
          <a href="{$post.user.posts_link}" class="username" rel="author">{$post.user.name|escape}</a>
        {else }
          <span class="username" rel="author">{$post.user.name|escape}</span>
        {/if}
        <span class="hint date">{$post.datetime|wa_datetime:"humandate"}</span>
        {if $show_comments && $post.comments_allowed}
          <a href="{$post.link}#comments" class="small">
            {if isset($post.comment_count) && $post.comment_count}{$post.comment_count} {$post.comment_str_translate}{else}[`no comments`]{/if}
          </a>
        {/if}

      </div>

      {* @event prepare_posts_frontend.%plugin_id%.before *}
      {if !empty($post.plugins.before)}
        <div class="text_before">
          <!-- plugin hook: "prepare_posts_frontend.*.before" -->
          {foreach $post.plugins.before as $plugin => $output}
            <!-- begin "prepare_posts_frontend.{$plugin}.before" -->
            {$output}
            <!-- end "prepare_posts_frontend.{$plugin}.before" -->
          {/foreach}
          <!-- end plugin hook: "prepare_posts_frontend.*.before" -->
        </div>
      {/if}

      <div class="text">
        {$post.text}
        {if $post.cutted}
          <a href="{$post.link}">{$post.cut_link_label|default:'[`Continue reading â†’`]'}</a>
        {/if}
      </div>

      {* @event prepare_posts_frontend.%plugin_id%.after *}
      {if !empty($post.plugins.after)}
        <div class="text_after">
          <!-- plugin hook: "prepare_posts_frontend.*.after" -->
          {foreach $post.plugins.after as $plugin => $output}
            <!-- begin "prepare_posts_frontend.{$plugin}.after" -->
            {$output}
            <!-- end "prepare_posts_frontend.{$plugin}.after" -->
          {/foreach}
          <!-- end plugin hook: "prepare_posts_frontend.*.after" -->
        </div>
      {/if}

    </div>
    {/if}

  {foreachelse} <!-- there no posts  -->

    {if !isset($page) || $page lt 2}
      {_w('%d post','%d posts',0,true)|escape}
    {/if}

  {/foreach}

  {if $layout_type neq 'page'}
    <div class="pageless-wrapper">

    {if isset($page) && $page lt $pages}
      {_w('%d post','%d posts',count($posts)+($page-1)*$posts_per_page,true)|escape}&nbsp;{_w('of %d post','of %d posts',$post_count,true)|escape}
      <br>
      <a href="?page={$page+1}" class="pageless-link">[`Show older posts`]</a>
      <div class="pageless-progress" style="display:none;"><i class="icon16 loading"><!-- icon --></i>[`Loading...`]</div>
    {elseif isset($page) && $pages}
      {_w('%d post','%s posts',$post_count,true)|escape}
    {/if}

    </div>
  {/if}
</div>

{capture name=paging}
{* used while JavaScript disabled or per page view *}

  <ul class="menu-h">
    {for $p=1 to $pages}
      <li{if $p eq $page} class="selected"{/if}><a href="{if $p eq $page}#page_{$page}{else}?page={$p}{/if}">{$p}</a></li>
    {/for}
  </ul>
{/capture}

{if !isset($page) or ($page le 1)}
  <script type="text/javascript">
  $.pageless({
    url: '?layout=lazyloading',
    target: '.lazyloading:first',
    scroll: function(response){
      var progress = '';
      if (response) {
        progress = '  <i class="icon16 loading"><'+'/i> <em>[`Loading`]...<'+'/em>';
      }
    },
    count: {$pages}
  });
  </script>

  <noscript>
    {$smarty.capture.paging}
  </noscript>
{elseif $layout_type neq 'lazyloading'}
  {$smarty.capture.paging}
{/if}