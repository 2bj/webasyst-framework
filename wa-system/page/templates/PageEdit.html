{if $ibutton}
<link href="{$wa_url}wa-content/js/jquery-plugins/ibutton/jquery.ibutton.min.css" rel="stylesheet" type="text/css" >
<script src="{$wa_url}wa-content/js/jquery-plugins/ibutton/jquery.ibutton.min.js"></script>
{/if}

<link type="text/css" rel="stylesheet" href="{{$wa_url}}wa-content/js/elrte/elrte.min.css"/>
<link type="text/css" rel="stylesheet" href="{{$wa_url}}wa-content/js/elrte/elrte-wa.css"/>
<script src="{$wa_url}wa-content/js/elrte/elrte.min.js"></script>
<script src="{$wa_url}wa-content/js/elrte/elrte-wa.js"></script>
{if $lang!='en'}<script src="{$wa_url}wa-content/js/elrte/i18n/elrte.{$lang}.js"></script>{/if}

<script type="text/javascript" src="{$wa_url}wa-content/js/codemirror/1/js/codemirror.js"></script>

<style>
    .wa-page-wysiwyg-html-toggle {
        margin-right: 17px;
        margin-top: -20px;
        float: right;
        margin-bottom: 0;
    }
    .wa-page-wysiwyg-html-toggle li {
        list-style: none;
        float: left;
    }

    .wa-page-wysiwyg-html-toggle li.selected a {
        background: white;
    }
    .wa-page-wysiwyg-html-toggle li a {
        display: block;
        color: #888;
        font-weight: bold;
        padding: 4px 12px 6px;
        text-decoration: none;
        font-size: 0.9em;
    }
    .wa-editor-core-wrapper {
        background: white;
    }

    .wa-ibutton-checkbox ul.menu-h li {
        padding: 1px 0 10px;
        vertical-align: middle;
    }
    .wa-page-gray {
        color: #AAA;
    }

    .wa-page-draft {
        background: #CCC;
        color: white;
        font-weight: bold;
        font-size: 0.8em;
        padding: 0 2px;
    }

    .wa-page-editor {
        border-left: 1px solid #ccc;
    }

    #wa-pages {
        padding: 0 5px 0 3px;
        margin-top: 7px;
    }

    #wa-pages li.selected a {
        background: #E7E7E7;
    }

    #wa-pages a {
        padding-left: 33px;
    }

    .wa-page-gray-toolbar {
        background: #EEE;
    }
</style>

{if $sidebar}
<div class="shadowed">
    <div class="sidebar left200px" style="min-height:300px">
        <div class="block not-padded">
            <ul id="wa-pages" class="menu-v collapsible with-icons ui-sortable">
                {foreach from=$pages item=p}
                <li id="page-{$p.id}"{if $page && $p.id == $page.id} class="selected"{/if}>
                    <a href="?module=pages&id={$p.id}">
                        <i class="icon16 notebook"></i>{$p.name|escape}
                        {* <span class="hint">{$p.url|escape}</span> *}
                        {if !$p.status} <span class="wa-page-draft">[s`draft`]</span>{/if}
                    </a>
                </li>
                {/foreach}
                <li class="top-padded{if !$page} selected{/if}">
                    <a href="?module=pages&id=" class="small"><i class="icon10 add"></i>[s`New page`]</a>
                </li>
            </ul>
        </div>
    </div>
{/if}
<div class="content{if $sidebar} left200px{/if}">
	<div class="wa-page-editor">
			<form id="wa-page-form" method="post" action="?module=pages&action=save{if $page}&id={$page.id}{/if}">
			<div class="block wa-page-gray-toolbar">
			{if $page}
			<div class="float-right">
				<ul class="menu-h">
					<li><a href="#" class="inline-link" id="wa-page-settings-toggle"><i class="icon16 edit"></i><b><i>[s`Page settings`]</i></b></a></li>
					<li><a class="wa-page-delete" href="?module=pages&action=delete"><i class="icon16 delete"></i>[s`Delete`]</a></li>
				</ul>
			</div>
			<script type="text/javascript">
			$(".wa-page-delete").click(function () {
				if (confirm('[s`This will delete entire page. Are you sure?`]')) {
					$.post($(this).attr('href'), { id:{$page.id}}, function () {
                        var li = $("#page-{$page.id}");
                        if (li.prev().length > 0) {
                            var href = li.prev().addClass('selected').find('a').attr('href');
                        } else if (li.next().length > 0) {
                            var href = li.next().addClass('selected').find('a').attr('href');
                        } else {
                            var hash = "?module=pages&id=";
                        }
                        location.href = href;
                    }, "json");
				}
				return false;
			});
			</script>
			{/if}
			<div>
				<h2>{if $page}{$page.name|escape}{if !$page.status} <span class="wa-page-draft">[s`draft`]</span>{/if}{else}[s`New page`]{/if}</h2>
				<div class="wa-page-urls small">
				    {if $page}
				       {if !empty($url)}
						<a href="{$url}{$page.url}?preview={$preview_hash}" title="[s`Preview`]" target="_blank">{$url|escape}{$page.url}</a><i class="icon10 new-window"></i>
					   {elseif !$routes}
					   [s`The page is not available on the website because “Site” app is not connected in the website structure.`]
					   {/if}
					{/if}
					<br />
				</div>
			</div>
				<div id="wa-page-settings" style="{if $page}display: none;{/if}">
					<div class="fields form">
						<div class="field-group">
						<div class="field">
							<div class="name bold">[s`Page name`]</div>
							<div class="value">
								<input type="text" class="bold large" name="info[name]" value="{if $page}{$page.name|escape}{/if}" />
							</div>
						</div>
                        <div class="field">
	                        <div class="value wa-ibutton-checkbox">
	                            <ul class="menu-h">
	                                <li><span id="wa-page-v-open-label" class="wa-page-gray">[s`Draft`]</span></li>
	                                <li><input type="checkbox" id="wa-page-v" name="info[status]" {if !$page || $page.status}checked="checked"{/if} /></li>
	                                <li><span id="wa-page-v-private-label">[s`Published`]</span></li>
	                            </ul>

	                        </div>
	                    </div>

                        <div class="field wa-page-url">
                            <div class="name bold">[s`Page URL`]</div>
                            <div class="value wa-page-app-url">
                                <input type="text" name="info[url]" class="bold" value="{if $page}{$page.url|escape}{/if}" />
                            </div>
                            {foreach $routes as $d => $d_routes}
                            {foreach $d_routes as $r_id => $r}
                            <div class="value small wa-page-app-url{if $r.exclude} gray{/if}">
                                <span{if $r.exclude} class="strike"{/if}>{$r.url|escape}<span class="wa-page-url-part">{if $page}{$page.url|escape}{/if}</span></span><a class="wa-page-exclude inline-link gray" title="{if $r.exclude}[s`Enable this URL`]{else}[s`Disable this URL`]{/if}" data-route="{$d|escape}:{$r_id}" href="#"><i {if !$r.exclude}style="display:none"{/if} class="icon10 lock-bw"></i><b><i>{if $r.exclude}[s`enable`]{else}[s`disable`]{/if}</i></b></a>
                                {if $r.exclude}<input type="hidden" name="exclude[]" value="{$d|escape}:{$r_id}" />{/if}
                            </div>
                            {/foreach}
                            {foreachelse}
                            <div class="value small wa-page-app-url">
                                <span style="color: red;">[`The page is not available on the website because “Site” app is not connected in the website structure.`]</span>
                            </div>
                            {/foreach}
                            {if $routes}
                            <div class="value hint" style="display: none">
                                <em>[s`When done editing, click “Save” to apply changes.`]</em>
                            </div>
                            {/if}
                        </div>

						</div>

						<div class="field-group">
                        <div class="field">
                            <div class="name">[s`<strong class="title">Title</strong>`] <span class="hint">&lt;title&gt;</span></div>
                            <div class="value"><input type="text" name="info[title]" value="{if $page}{$page.title|escape}{/if}" class="bold" /></div>
                        </div>
						{foreach from=$params key=n item=p}
						<div class="field">
							<div class="name">{$vars[$n]}</div>
							{if $n == 'description'}
							<div class="value"><textarea name="params[{$n}]">{$p|escape}</textarea></div>
							{else}
							<div class="value"><input type="text" name="params[{$n}]" value="{$p|escape}" /></div>
							{/if}
						</div>
						{/foreach}
						</div>

						<div class="field">
							<div class="name">[s`Page custom parameters`]</div>
							<div class="value">
								<textarea name="other_params">{if $page}{foreach from=$other_params item=v key=k}{$k}={$v|escape}
{/foreach}{/if}</textarea><br />
								<span class="hint">[s`Optional set of custom <em>key=value</em> parameters which can be used within page.html template or this page content as <em>&#123;$page.key&#125;</em>. Each key=value pair should be on a separate line.`] <a href="[`http://www.webasyst.com/framework/docs/site/pages/`]" target="_blank">[s`Help`]</a> <i class="icon10 new-window"></i></span>
							</div>
						</div>
					</div>
					<br clear="left" />
				</div>
		</div>
		<div class="wa-editor-core-wrapper">
			<ul class="wa-page-wysiwyg-html-toggle">
				<li><a id="wysiwyg" href="#">[s`WYSIWYG`]</a></li>
				<li class="selected"><a id="html" href="#">HTML</a></li>
			</ul>
			<div style="clear:both">
				<textarea style="display:none" id="wa-page-content" name="info[content]">{if $page}{$page.content|escape}{/if}</textarea>
			</div>
		</div>
        <div class="block">
             <input id="wa-page-button" type="submit" class="button green" value="[s`Save`]" />
             <em class="hint">Ctrl + S</em>
             <span id="wa-page-status" style="margin-left: 20px; display: none"></span>
        </div>
		</form>
		<script type="text/javascript">
            $(function () {
			var wa_url = "{$wa_url}";
			var wa_lang = "{$lang}";

            var h = $("div.wa-page-editor").height() - $("div.wa-page-editor .wa-gray-toolbar").height() - 50;
            if (h < 300) {
                h = 300;
            }
            var editorKey = false;
            var editorKeyCallback = function (press) {
                if (press) {
                    return function (e) {
                        if (!$('#wa-page-button').length) {
                            return;
                        }
                        if (e.ctrlKey && e.which == 115 && !editor_key) {
                            $('#wa-page-button').click();
                            e.preventDefault();
                        }
                    }
                } else {
                    return function (e) {
                        editor_key = false;
                        if (!$('#wa-page-button').length) {
                            return;
                        }
                        if (e.ctrlKey && e.which == 83) {
                            editor_key = true;
                            $('#wa-page-button').click();
                            e.preventDefault();
                        }
                        if (e.metaKey) {
                            return;
                        }
                        if ((e.which < 33 || e.which > 40) &&
                                (e.which > 27 || e.which == 8 || e.which == 13) &&
                                (e.which < 112 || e.which > 124) &&
                                (!e.ctrlKey || e.which != 67)
                                ) {
                            $('#wa-page-button').removeClass('green').addClass('yellow');
                        }
                    }
                }
            }

            document.editor = CodeMirror.fromTextArea('wa-page-content', {
                minHeight: h,
                height: "dynamic",
                parserfile: ["parsexml.js", "parsecss.js", "tokenizejavascript.js", "parsejavascript.js", "parsehtmlmixed.js"],
                stylesheet: [wa_url + "wa-content/js/codemirror/1/css/xmlcolors.css",
                             wa_url + "wa-content/js/codemirror/1/css/jscolors.css",
                             wa_url + "wa-content/js/codemirror/1/css/csscolors.css"],
                path: wa_url + "wa-content/js/codemirror/1/js/",
                initCallback: function (editor) {
                    editor.frame.contentWindow.document.addEventListener('keydown', editorKeyCallback(), false);
                    editor.frame.contentWindow.document.addEventListener('keypress', editorKeyCallback(true), false);
                }
            });

            h -= 55;
            if ($("#wa-app").height() < $("#wa").height() - $("#wa-header").height()) {
                h += $("#wa").height() - $("#wa-header").height() - $("#wa-app").height();
            }
            if (h < 300) {
                h = 300;
            }

                // init elrte editor
            elRTE.prototype.beforeSave = function () {};
            elRTE.prototype.options.toolbars.waPageToolbar = ['wa_style', 'alignment', 'colors', 'format', 'indent', 'lists', 'wa_image', 'wa_links', 'wa_elements', 'wa_tables', 'direction'];

            $("#wa-page-content").elrte({
                height: h,
                cssfiles: [wa_url + "wa-content/css/wa/wa-1.0.css"],
                toolbar: 'waPageToolbar',
                lang: wa_lang,
                wa_image_upload: '?module=files&action=uploadimage',
                width: "100%"
            });

            {literal}
            var f = $("#wa-page-content").elrte()[0].elrte.filter.source;
            $("#wa-page-content").elrte()[0].elrte.filter.source = function (html) {
                var html = f.call($("#wa-page-content").elrte()[0].elrte.filter, html);
                html = html.replace(/%7B\$wa_url%7D/, '{$wa_url}');
                html = html.replace(/{[a-z$][^}]*}/gi, function (match, offset, full) {
                    var i =	full.indexOf('</script', offset + match.length);
                    var j = full.indexOf('<script', offset + match.length);
                    if (i == -1 || (j != -1 && j < i)) {
                        match = match.replace(/&gt;/g, '>');
                        match = match.replace(/&lt;/g, '<');
                        match = match.replace(/&amp;/g, '&');
                        match = match.replace(/&quot;/g, '"');
                    }
                    return match;
                });
                return html;
            };
            $('.el-rte iframe').contents()
            .keydown(editorKeyCallback())
            .keypress(editorKeyCallback(true))
            .keyup(function(e) {
                //all dialogs should be closed when Escape is pressed
                if (e.keyCode == 27) {
                    jQuery(".dialog:visible").trigger('esc');
                }
            });
            $('.el-rte .toolbar li').click(function () {
                $('#wa-page-button').removeClass('green').addClass('yellow');
            });
            {/literal}

            // bind click handlers to buttons
            $("#wysiwyg").click(function () {
                $.storage.set('{$wa->app()}/editor', 'wysiwyg');
                $("ul.wa-page-wysiwyg-html-toggle li.selected").removeClass('selected');
                $(this).parent().addClass('selected');
                $("div.CodeMirror-wrapping").hide();
                $("#wa-page-content").elrte('val', document.editor.getCode());
                $('.el-rte iframe').contents().find('img[src*="$wa_url"]').each(function () {
                    var s = decodeURIComponent($(this).attr('src'));
                    $(this).attr('data-src', s);
                    {literal}
                    $(this).attr('src', s.replace(/\{\$wa_url\}/, wa_url));
                    {/literal}
                });
                $(".el-rte").show();
                $('.el-rte iframe').contents().find('body').focus();
                return false;
            });

            $("#html").click(function () {
                $.storage.set('{$wa->app()}/editor', 'html');
                $("ul.wa-page-wysiwyg-html-toggle li.selected").removeClass('selected');
                $(this).parent().addClass('selected');
                $('.el-rte iframe').contents().find("img[data-src!='']").each(function () {
                    $(this).attr('src', $(this).attr('data-src'));
                });
                document.editor.setCode($("#wa-page-content").elrte('val'));
                $(".el-rte").hide();
                $("div.CodeMirror-wrapping").show();
                return false;
            });

            // show active editor
            if ($.storage.get('site/editor') == 'wysiwyg') {
                $("ul.wa-page-wysiwyg-html-toggle li.selected").removeClass('selected');
                $("#wysiwyg").parent().addClass('selected');
                $('.el-rte iframe').contents().find('img[src*="$wa_url"]').each(function () {
                    var s = decodeURIComponent($(this).attr('src'));
                    $(this).attr('data-src', s);
                    {literal}
                    $(this).attr('src', s.replace(/\{\$wa_url\}/, wa_url));
                    {/literal}
                });
                $("div.CodeMirror-wrapping").hide();
            } else {
                $(".el-rte").hide();
            }


            $("div.wa-page-app-url input[type=text]").keyup(function () {
                $("div.wa-page-app-url span.wa-page-url-part").html($(this).val());
            });


            $("a.wa-page-exclude").click(function () {
                var d = $(this).parent();
                if (d.hasClass('gray')) {
                    d.removeClass('gray');
                    d.children('span').removeClass('strike');
                    d.find('input').remove();
                    $(this).children('i').hide();
                    $(this).attr('title', '[s`Disable this URL`]');
                    $(this).find('b i').html('[s`disable`]');
                } else {
                    d.addClass('gray');
                    d.children('span').addClass('strike');
                    d.append('<input type="hidden" name="exclude[]" value="' + $(this).attr('data-route') + '" />');
                    $(this).children('i').show();
                    $(this).attr('title', '[s`Enable this URL`]');
                    $(this).find('b i').html('[s`enable`]');
                }
                $(".wa-page-url div.value.hint").show();
                $('#wa-page-button').removeClass('green').addClass('yellow');
                return false;
            });


            var iButtonInit = function () {
                $("#wa-page-v").iButton({
                    labelOn: "",
                    labelOff: "",
                    classContainer: 'ibutton-container mini'
                });
            };
            if ($("#wa-page-settings").is(":visible")) {
                setTimeout(iButtonInit, 200);
            } else {
                $("#wa-page-settings-toggle").one('click', function () {
                    setTimeout(iButtonInit, 100);
                });
            }
            var status_check = function(item){
                if ($(item).is(':checked')) {
                    $('#wa-page-v-open-label').addClass('wa-page-gray');
                    $('#wa-page-v-private-label').removeClass('wa-page-gray');
                }
                else {
                    $('#wa-page-v-open-label').removeClass('wa-page-gray');
                    $('#wa-page-v-private-label').addClass('wa-page-gray');
                }
            };
            status_check($('#wa-page-v'));
            $('#wa-page-v').change(function(){
                $('#wa-page-button').removeClass('green').addClass('yellow');
                status_check(this);
            });




            $("#wa-page-form").submit(function () {
                if ($(".el-rte").length && $(".el-rte").is(':visible')) {
                    $('.el-rte iframe').contents().find("img[data-src!='']").each(function () {
                        $(this).attr('src', $(this).attr('data-src'));
                    });
                    $("#wa-page-content").val($("#wa-page-content").elrte('val'));
                    $("#wa-page-content").elrte('val', $("#wa-page-content").val());
                    $('.el-rte iframe').contents().find('img[src*="$wa_url"]').each(function () {
                        var s = decodeURIComponent($(this).attr('src'));
                        $(this).attr('data-src', s);
                        {literal}
                        $(this).attr('src', s.replace(/\{\$wa_url\}/, wa_url));
                        {/literal}
                    });
                } else if (document.editor) {
                    $("#wa-page-content").val(document.editor.getCode());
                }
                var form = $(this);
                $("#wa-page-status").html("<i class='icon16 loading'></i> [s`Saving...`]").fadeIn("slow");
                $.post(form.attr('action'), form.serialize(), function (response) {
                    if (response.status == 'ok') {
                        $(".error").removeClass('error');
                        $("#wa-page-status").html('<i class="icon16 yes"></i> [s`Saved`]').fadeOut('slow');
                        $('#wa-page-button').removeClass('yellow').removeClass('red').addClass('green');
                        var p = response.data;
                        if (!p.status) {
                            p.name += ' <span class="wa-page-draft">[`draft`]</span>';
                        }

                        var html = $('<li id="page-' + p.id + '" class="sortable selected">' +
                                '<a href="?module=pages&id=' + p.id + '"><i class="icon16 notebook"></i>' + p.name +
                                ' </a></li>');
                        if (!response.data.add) {
                            $("#page-" + p.id).replaceWith(html);
                            $(".wa-page-editor h2").html(p.name);
                        }

                        $(".wa-page-urls").empty();
                        if (p.url != null) {
                            $(".wa-page-urls").append(
                                    $('<a target="_blank" href=""></a>')
                                            .attr('href', p.url + '?preview={$preview_hash}')
                                            .text(p.url)
                            ).append('<i class="icon10 new-window"></i><br />');
                        }
                        if (p.add) {
                            location.href = '?module=pages&id=' + p.id;
                        }
                    } else if (response.status == 'fail') {
                        if ($.isArray(response.errors)) {
                            var e = response.errors[0];
                            $(response.errors[1]).addClass('error');
                        } else {
                            var e = response.errors;
                        }
                        $("#wa-page-status").html('<b style="color:red">' + (e ? e : $_('An error occurred while saving')) + '</b>');
                        $('#wa-page-button').removeClass('yellow').removeClass('green').addClass('red');
                    }
                }, "json");
                // restore focus to editors
                if ($(".el-rte").length && $(".el-rte").is(':visible')) {
                    try {
                        $("#wa-page-content").elrte()[0].elrte.selection.moveToBookmark($("#wa-page-content").elrte()[0].elrte.selection.getBookmark());
                    } catch (e) {}
                } else {
                    document.editor.focus();
                }
                return false;
            });


            $('#wa-page-settings-toggle').click(function(){
                $('#wa-page-settings').toggle();
                return false;
            });

            $('#wa-page-url-edit-link').click(function (){
    			$('#wa-page-url-editable').hide();
    			$('#wa-page-url-edit').show().focus();
    			return false;
    		});

            $("#wa-pages").sortable({
                distance: 5,
                helper: 'clone',
                items: 'li',
                opacity: 0.75,
                tolerance: 'pointer',
                stop: function (event, ui) {
                    var li = $(ui.item);
                    var id = li.attr('id').replace(/page-/, '');
                    var pos = li.prevAll('li').size() + 1;
                    $.post("?module=pages&action=sort", { id: id, pos: pos}, function () {
                    }, "json");
                }
            });
            });
        </script>
		<div class="clear"></div>
	</div>
</div>
{if $sidebar}
</div>
{/if}